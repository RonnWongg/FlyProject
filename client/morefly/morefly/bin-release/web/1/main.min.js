var ConnectionData=function(){function t(){}var i=(__define,t);i.prototype;return t.RoomNum=6,t.host="127.0.0.1",t.port=3e3,t}();egret.registerClass(ConnectionData,"ConnectionData");var MapData=function(){function t(){this.redinit=[[98,595,1],[20,520,1],[20,560,1],[60,520,1],[60,560,1]],this.yelinit=[[15,255,2],[50,180,2],[50,220,2],[85,180,2],[85,220,2]],this.greinit=[[350,175,3],[390,210,3],[390,250,3],[425,210,3],[425,250,3]],this.bluinit=[[430,510,4],[360,550,4],[360,590,4],[400,550,4],[400,590,4]],this.col=[1,2,3,4],this.roundData=[],this.endData=[],this.roundDataInit(),this.endDataInit()}var i=(__define,t),e=i.prototype;return e.roundDataInit=function(){for(var t=0;52>t;t++){this.roundData[t]=[],this.roundData[t][2]=this.col[t%4];var i=15,e=295;4>t?(this.roundData[t][0]=30*t+i,this.roundData[t][1]=e):8>t?(this.roundData[t][0]=120+i,this.roundData[t][1]=e-30*(t-3)):13>t?(this.roundData[t][0]=30*(t-3)+i,this.roundData[t][1]=e-120):17>t?(this.roundData[t][0]=300+i,this.roundData[t][1]=e+30*(t-17)):21>t?(this.roundData[t][0]=30*(t-6)+i,this.roundData[t][1]=e):26>t?(this.roundData[t][0]=420+i,this.roundData[t][1]=e+30*(t-20)):30>t?(this.roundData[t][0]=30*(40-t)+i,this.roundData[t][1]=e+180):34>t?(this.roundData[t][0]=300+i,this.roundData[t][1]=e+30*(t-23)):39>t?(this.roundData[t][0]=30*(43-t)+i,this.roundData[t][1]=e+300):43>t?(this.roundData[t][0]=120+i,this.roundData[t][1]=e+30*(49-t)):47>t?(this.roundData[t][0]=30*(46-t)+i,this.roundData[t][1]=e+180):52>t&&(this.roundData[t][0]=i,this.roundData[t][1]=e+30*(52-t))}},e.endDataInit=function(){for(var t=15,i=295,e=0;24>e;e++)this.endData[e]=[],6>e?(this.endData[e][0]=t+210,this.endData[e][1]=i+300-30*(e+1),this.endData[e][2]=1):12>e?(this.endData[e][0]=t+30*(e-5),this.endData[e][1]=i+90,this.endData[e][2]=2):18>e?(this.endData[e][0]=t+210,this.endData[e][1]=i-120+30*(e-11),this.endData[e][2]=3):(this.endData[e][0]=t+420-30*(e-17),this.endData[e][1]=i+90,this.endData[e][2]=4)},e.getRoundData=function(){return this.roundData},e.getEndData=function(){return this.endData},t.posData=[[20,520],[20,170],[370,180],[360,530]],t}();egret.registerClass(MapData,"MapData");var Connection=function(){function t(t,i){this.m_Events=[],this.m_Error="",this.m_Host=t,this.m_Port=i}var i=(__define,t),e=i.prototype;return e.bindEvents=function(){for(var t in this.m_Events)this.socket.on(t,this.m_Events[t])},e.setError=function(t){this.m_Error=t},e.getError=function(){return this.m_Error},e.connect=function(){return"io"in window?(this.socket=io.connect("http://"+this.m_Host+":"+this.m_Port),this.bindEvents(),!0):(this.setError("io not defined"),!1)},e.login=function(t){this.socket.emit("login",{name:t})},e.joinRoom=function(t,i){this.socket.emit("joinRoom",{rid:t,pid:i})},e.leavePid=function(t,i){this.socket.emit("leaveRoom",{rid:t,pid:i})},e.ready=function(){this.socket.emit("ready","")},e.on=function(t,i){return this.m_Events[t]=i,self},e.rollGo=function(){this.socket.emit("rollGo","")},e.stepsUpdate=function(t,i){this.socket.emit("stepsUpdate",{id:t,lastStep:i})},e.Over=function(t,i,e){this.socket.emit("over",{id:t,rid:i,pid:e})},e.replace=function(t){this.socket.emit("eat",{id:t})},t}();egret.registerClass(Connection,"Connection");var HandleEvt=function(t){function i(){t.call(this),this.allLine=[],this.init()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.drawbtn=function(){this.startbtn=new egret.Bitmap,this.startbtn.texture=RES.getRes("start_png"),this.startbtn.x=150,this.startbtn.y=665,this.startbtn.touchEnabled=!0},s.getData=function(){this.data=new MapData;var t=this.data.getRoundData(),i=this.data.getEndData();this.redLine=this.data.redinit.slice(0,1).concat(t.slice(39,52)).concat(t.slice(0,37)).concat(i.slice(0,6)),this.yelLine=this.data.yelinit.slice(0,1).concat(t.slice(0,50)).concat(i.slice(6,12)),this.greLine=this.data.greinit.slice(0,1).concat(t.slice(13,52)).concat(t.slice(0,11)).concat(i.slice(12,18)),this.bluLine=this.data.bluinit.slice(0,1).concat(t.slice(26,52)).concat(t.slice(0,24)).concat(i.slice(18,24)),this.allLine=[this.redLine,this.yelLine,this.greLine,this.bluLine]},s.init=function(){this.socket=new Connection(ConnectionData.host,ConnectionData.port),this.setOn(),this.lv=new LoginView,this.addChild(this.lv),this.lv.addEventListener(egret.TouchEvent.TOUCH_TAP,this.login,this)},s.login=function(t){this.lv.getLoginText()&&(this.socket.connect(),this.socket.login(this.lv.getLoginText()))},s.gameState=function(t){var i=0,e=t.target.name;"down"==e?console.log(t.target.name):this.socket.joinRoom(i,e)},s.setOn=function(){var t=this;this.socket.on("login",function(i){1==i.ret?t.loginSucceed(i):t.loginFailed()}),this.socket.on("joinRoom",function(i){t.joinRoomMsg(i)}),this.socket.on("ready",function(i){console.log("id:"+i.id+",name:"+i.name+",rid:"+i.rid+",pid:"+i.pid+",status:"+i.status+" . ready"),t.txtMsg.text="name:"+i.name+",pid:"+i.pid+" ready"}),this.socket.on("start",function(i){t.GoStart(i)}),this.socket.on("rollGo",function(i){t.rollStart(i)}),this.socket.on("rollStop",function(i){t.rollStop(i)}),this.socket.on("over",function(i){var e=i.over;t.Gameover(e)}),this.socket.on("outLine",function(i){t.MsgToAll(i)}),this.socket.on("joinRoomError",function(){t.joinRoomError()})},s.joinRoomError=function(){this.txtMsg.text="加入失败，再找个位置."},s.loginSucceed=function(t){this.removeChild(this.lv),this.personName=t.name,this.rv=new RoomView,this.addChild(this.rv),this.pv=new PositionView,this.pv.addEventListener(egret.TouchEvent.TOUCH_TAP,this.gameState,this),this.addChild(this.pv),this.txtMsg=new egret.TextField,this.txtMsg.background=!0,this.txtMsg.backgroundColor=15527148,this.txtMsg.border=!0,this.txtMsg.borderColor=0,this.txtMsg.size=35,this.txtMsg.text="请加入位置，状态准备",this.txtMsg.textColor=0,this.txtMsg.height=50,this.txtMsg.width=400,this.txtMsg.textAlign=egret.HorizontalAlign.CENTER,this.txtMsg.x=40,this.txtMsg.y=10,this.addChild(this.txtMsg)},s.loginFailed=function(){console.log("fail")},s.joinRoomMsg=function(t){this.pv.getChildAt(t.pid).touchEnabled=!1,this.pv.getChildAt(t.pid).width=this.pv.getChildAt(t.pid).height=50,this.txtMsg.text="name:"+t.name+" joinRoom. pid:"+t.pid,this.personName==t.name&&(this.removeChild(this.pv),this.drawbtn(),this.rv.addChild(this.startbtn),this.startbtn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.socket.ready(),console.log("触发了")},this))},s.GoStart=function(t){this.rv.removeChild(this.startbtn),this.getData(),this.drawPlane(t),this.personID=t.id,this.personRid=t.rid,this.personPid=t.pid,this.personOrder=t.order},s.drawPlane=function(t){for(var i=1;5>i;i++){var e=new egret.Bitmap;e.texture=RES.getRes(i+"_png"),e.x=this.allLine[i-1][0][0],e.y=this.allLine[i-1][0][1],e.name=i.toString(),this.rv.addChild(e)}this.txtMsg.text="游戏开始了",this.rol=new Roll,this.rol.x=200,this.rol.y=660,this.addChild(this.rol),1==t.pid?(this.rol.touchEnabled=!0,this.txtMsg.text="你先开始"):this.rol.touchEnabled=!1,this.rol.addEventListener(egret.TouchEvent.TOUCH_TAP,this.playerRoll,this)},s.playerRoll=function(t){this.socket.rollGo(),this.rol.touchEnabled=!1},s.rollStart=function(t){this.rol.mc.play(-1),this.hisId=t.id,this.hisRid=t.rid,this.hisPid=t.pid},s.rollStop=function(t){var i=t.val;this.curStep=t.currentStep,this.curVal=t.val;var e=t.val+t.currentStep;this.lastStep=e,egret.setTimeout(this.stop,this,1e3,i)},s.stop=function(t){this.rol.mc.gotoAndStop(t),console.log("begin:"+this.curStep+",stop:"+this.lastStep);var i="";if(1==this.hisPid&&(i="红色"),2==this.hisPid&&(i="黄色"),3==this.hisPid&&(i="绿色"),4==this.hisPid&&(i="蓝色"),this.txtMsg.text=""+i+"投掷了 "+t+" 点",this.lastStep>55){var e=56-this.curStep,s=new egret.Timer(500,e);console.log("lastStep:"+this.lastStep+",setVal:"+e)}else{var s=new egret.Timer(500,t);console.log("normal val:"+t)}s.addEventListener(egret.TimerEvent.TIMER,this.fly,this),s.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.flycomplete,this),s.start()},s.fly=function(t){var i=this.hisPid,e=t.target.currentCount,s=this.rv.getChildAt(i);egret.Tween.get(s).to({x:this.allLine[i-1][this.curStep+e][0],y:this.allLine[i-1][this.curStep+e][1]},500,egret.Ease.cubicInOut)},s.flycomplete=function(){var t=this.lastStep,i=this.hisPid,e=this.rv.getChildAt(i);51>t&&this.Replace(i,t),50>t&&this.allLine[i-1][t][2]==i?(18==t&&(this.lastStep=t+12,egret.setTimeout(function(){egret.Tween.get(e).to({x:this.allLine[i-1][t][0],y:this.allLine[i-1][t][1]},1e3,egret.Ease.cubicInOut)},this,500),egret.setTimeout(function(){},this,500)),egret.setTimeout(function(){var t=new egret.Timer(500,4);t.addEventListener(egret.TimerEvent.TIMER,this.StepUp,this),t.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.StepUpComplete,this),t.start()},this,500)):(this.personID==this.hisId&&this.socket.stepsUpdate(this.hisId,t),6==this.curVal&&this.personID==this.hisId&&(this.txtMsg.text="再摇一次.",this.rol.touchEnabled=!0),6!=this.curVal&&this.playerOrder(),t>55&&this.personID==this.hisId&&this.socket.Over(this.hisId,this.hisRid,this.hisPid))},s.StepUp=function(t){var i=this.lastStep,e=this.hisPid,s=this.rv.getChildAt(e),n=t.target.currentCount;egret.Tween.get(s).to({x:this.allLine[e-1][i+n][0],y:this.allLine[e-1][i+n][1]},500,egret.Ease.cubicInOut)},s.StepUpComplete=function(){var t=this.lastStep+4,i=this.hisPid,e=this.rv.getChildAt(i);this.Replace(i,t),18==t&&(t+=12,egret.setTimeout(function(){egret.Tween.get(e).to({x:this.allLine[i-1][t][0],y:this.allLine[i-1][t][1]},1500,egret.Ease.cubicInOut)},this,1e3),this.Replace(i,t)),this.personID==this.hisId&&this.socket.stepsUpdate(this.hisId,t),6==this.curVal&&this.personID==this.hisId&&(this.txtMsg.text="再摇一次.",this.rol.touchEnabled=!0),6!=this.curVal&&this.playerOrder()},s.Gameover=function(t){this.removeChildren();var i=new GameOver(t);this.addChild(i),i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,this.reStart,this)},s.reStart=function(t){this.addChild(this.rv),this.rv.removeChildAt(4),this.rv.removeChildAt(3),this.rv.removeChildAt(2),this.rv.removeChildAt(1),this.txtMsg.text="",this.addChild(this.txtMsg),this.pv=new PositionView,this.pv.addEventListener(egret.TouchEvent.TOUCH_TAP,this.gameState,this),this.addChild(this.pv)},s.Replace=function(t,i){for(var e=[],s=0,n=0,o=1;5>o;o++){var h=this.rv.getChildAt(o);s=Math.floor(h.x),n=Math.floor(h.y),e[o]=[s,n]}for(var r=this.allLine[t-1][i][0],a=this.allLine[t-1][i][1],d=function(i){if(i!=t&&e[i][0]==r&&e[i][1]==a){var s=l.rv.getChildAt(i);egret.setTimeout(function(){egret.Tween.get(s).to({x:this.allLine[i-1][0][0],y:this.allLine[i-1][0][1]},1500,egret.Ease.circInOut)},l,100),console.log("pid:"+t+" eat "+i),l.personID==l.hisId&&l.socket.replace(i-1)}},l=this,o=1;5>o;o++)d(o)},s.playerOrder=function(){this.personID==this.hisId?(this.rol.touchEnabled=!1,this.txtMsg.text="轮到下一位"):(1==this.hisPid&&2==this.personPid&&(this.rol.touchEnabled=!0,this.txtMsg.text="小子，到你了"),2==this.hisPid&&3==this.personPid&&(this.rol.touchEnabled=!0,this.txtMsg.text="小子，到你了"),3==this.hisPid&&4==this.personPid&&(this.rol.touchEnabled=!0,this.txtMsg.text="小子，到你了"),4==this.hisPid&&1==this.personPid&&(this.rol.touchEnabled=!0,this.txtMsg.text="小子，到你了"))},s.MsgToAll=function(t){var i=t.name,e=t.pid;this.txtMsg.text="pid:"+e+",name:"+i+" 掉了",this.contains(this.rol)&&this.removeChild(this.rol),this.rv.contains(this.startbtn)&&this.rv.removeChild(this.startbtn),this.rv.numChildren>3&&(this.rv.removeChildAt(4),this.rv.removeChildAt(3),this.rv.removeChildAt(2),this.rv.removeChildAt(1)),egret.setTimeout(function(){this.txtMsg.text="再找个位置"},this,1e3),this.pv=new PositionView,this.pv.addEventListener(egret.TouchEvent.TOUCH_TAP,this.gameState,this),this.addChild(this.pv)},i}(egret.Sprite);egret.registerClass(HandleEvt,"HandleEvt");var Main=function(t){function i(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.createGameScene())},s.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},s.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},s.createBitmapByName=function(t){var i=new egret.Bitmap,e=RES.getRes(t);return i.texture=e,i},s.createGameScene=function(){this.bg=this.createBitmapByName("bg_png"),this.addChild(this.bg),this.he=new HandleEvt,this.he.width=480,this.he.height=800,this.addChild(this.he)},i}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var GameOver=function(t){function i(i){t.call(this),this.init(i),console.log("over:"+i)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.init=function(t){0==t?this.winner():this.loser()},s.winner=function(){console.log("win");var t=RES.getRes("winer_json"),i=RES.getRes("winer_png");this.mcf=new egret.MovieClipDataFactory(t,i),this.mc=new egret.MovieClip(this.mcf.generateMovieClipData("winer")),this.addChild(this.mc),this.mc.play()},s.loser=function(){console.log("loser");var t=RES.getRes("lose_json"),i=RES.getRes("lose_png");this.mcf=new egret.MovieClipDataFactory(t,i),this.mc=new egret.MovieClip(this.mcf.generateMovieClipData("lose")),this.addChild(this.mc),this.mc.play()},i}(egret.Sprite);egret.registerClass(GameOver,"GameOver");var HallView=function(t){function i(){t.call(this),this.init()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.init=function(){var t=this.drawRoom(6);this.sv=new egret.ScrollView,this.sv.width=400,this.sv.height=750,this.sv.x=40,this.sv.bounces=!1,this.sv.setContent(t),this.addChild(this.sv)},s.drawRoom=function(t){var i;this.roomView=new egret.Sprite;for(var e=0;t>e;e++){var s=this.single();i=e.toString();var n=new egret.TextField;n.text="No."+i,n.y=150,n.height=50,n.width=400,n.size=30,n.textAlign=egret.HorizontalAlign.CENTER,s.addChild(n),s.name=i,s.y=200*e,s.touchEnabled=!0,this.roomView.addChild(s)}return this.roomView},s.single=function(){var t=new egret.Sprite;t.width=400,t.height=200;var i=new egret.Bitmap;return i.texture=RES.getRes("room_png"),t.addChild(i),i.x=75,t},i}(egret.Sprite);egret.registerClass(HallView,"HallView");var LoadingUI=function(t){function i(){t.call(this),this.createView()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},s.setProgress=function(t,i){this.textField.text="Loading..."+t+"/"+i},i}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var LoginView=function(t){function i(){t.call(this),this.drawLogin()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.drawLogin=function(){this.loginText=new egret.TextField,this.loginText.x=150,this.loginText.y=200,this.loginText.width=150,this.loginText.height=38,this.loginText.type=egret.TextFieldType.INPUT,this.loginText.background=!0,this.loginText.backgroundColor=16777215,this.loginText.textColor=0,this.loginText.size=35,this.addChild(this.loginText),this.loginButton=new egret.Bitmap,this.loginButton.texture=RES.getRes("login_png"),this.loginButton.touchEnabled=!0,this.loginButton.x=150,this.loginButton.y=250,this.loginButton.touchEnabled=!0,this.addChild(this.loginButton)},s.getLoginText=function(){return this.loginText.text},i}(egret.Sprite);egret.registerClass(LoginView,"LoginView");var Player=function(){function t(){}var i=(__define,t),e=i.prototype;return e.getPname=function(){return this.pname},e.setPname=function(t){this.pname=t},e.setCol=function(t){this.col=t},e.setPath=function(t){this.path=t},e.setId=function(t){this.id=t},e.setRid=function(t){this.rid=t},e.setPid=function(t){this.pid=t},e.getCol=function(){return this.col},e.getPath=function(){return this.path},e.getId=function(){return this.id},e.getRid=function(){return this.rid},e.getPid=function(){return this.pid},t}();egret.registerClass(Player,"Player");var PositionView=function(t){function i(){t.call(this),this.shutdown=new egret.Bitmap,this.shutdown.texture=RES.getRes("shutdown_png"),this.shutdown.x=420,this.shutdown.name="down",this.shutdown.touchEnabled=!0,this.addChild(this.shutdown),this.p1=new egret.Bitmap,this.p1.texture=RES.getRes("p1_png"),this.p1.width=this.p1.height=100,this.p1.x=MapData.posData[0][0],this.p1.y=MapData.posData[0][1],this.p1.touchEnabled=!0,this.addChild(this.p1),this.p2=new egret.Bitmap,this.p2.texture=RES.getRes("p2_png"),this.p2.width=this.p2.height=100,this.p2.x=MapData.posData[1][0],this.p2.y=MapData.posData[1][1],this.p2.touchEnabled=!0,this.addChild(this.p2),this.p3=new egret.Bitmap,this.p3.texture=RES.getRes("p3_png"),this.p3.width=this.p3.height=100,this.p3.x=MapData.posData[2][0],this.p3.y=MapData.posData[2][1],this.p3.touchEnabled=!0,this.addChild(this.p3),this.p4=new egret.Bitmap,this.p4.texture=RES.getRes("p4_png"),this.p4.width=this.p4.height=100,this.p4.x=MapData.posData[3][0],this.p4.y=MapData.posData[3][1],this.p4.touchEnabled=!0,this.addChild(this.p4),this.p1.name="1",this.p2.name="2",this.p3.name="3",this.p4.name="4"}__extends(i,t);var e=(__define,i);e.prototype;return i}(egret.Sprite);egret.registerClass(PositionView,"PositionView");var Roll=function(t){function i(){t.call(this),this.val=0,this.init()}__extends(i,t);var e=(__define,i),s=e.prototype;return s.init=function(){var t=RES.getRes("dice_json"),i=RES.getRes("dice_png");this.mcf=new egret.MovieClipDataFactory(t,i),this.mc=new egret.MovieClip(this.mcf.generateMovieClipData("dice")),this.addChild(this.mc)},s.setVal=function(){this.val=Math.floor(6*Math.random())+1},s.getVal=function(){return this.val},s.roll=function(t){this.mc.play(-1),this.mc.addEventListener(egret.Event.COMPLETE,this.complete,this)},s.complete=function(t){},i}(egret.Sprite);egret.registerClass(Roll,"Roll");var RoomView=function(t){function i(){t.call(this),this.rvbg=new egret.Bitmap,this.rvbg.texture=RES.getRes("plane_bg_png"),this.addChild(this.rvbg)}__extends(i,t);var e=(__define,i),s=e.prototype;return s.init=function(){this.pos=new egret.Sprite,this.addChild(this.pos)},i}(egret.Sprite);egret.registerClass(RoomView,"RoomView");